!function(e,t){"function"==typeof define&&define.amd?define(["Zepto"],t):"object"==typeof module&&module.exports?module.exports=t(require("Zepto")):e.InfiniteList=t(e.Zepto)}(this,function(e){function t(){}function i(e){return"[object Array]"===Object.prototype.toString.call(e)}var n=function(e){return e?void this._setOptions(e):void console.warn("Infinitelist init options can not be null!")};return n.prototype={_setOptions:function(i){if(!i.listId)return void console.warn("Options-listId can not be null!");if(!i.dataLoader)return void console.warn("Options-dataLoader can not be null!");if(!i.htmlRender)return void console.warn("Options-htmlRender can not be null!");var n=i.listId.indexOf("#")>-1?i.listId:"#"+i.listId;this._listWrap=e(n),this._dataLoader=i.dataLoader,this._htmlRender=i.htmlRender,this._pageSize=i.pageSize||10,this._threshold=i.threshold||300,this._pageKeepSize=i.pageKeepSize||6,this._recycle=!!i.recycle,this._pageCache=!!i.pageCache,this._listNomore=i.listNomore||function(){return'<div style="text-align:center;padding:10px 0;">No more</div>'},this._listLoading=e(i.listLoading||'<div style="text-align: center;padding: 10px 0;">Loading...</div>'),this._loadDone=i.loadDone||t,this._cacheKey=i.storageName||"INFINITELISTCACHE",this._pageIndex=1,this._pageListData={},this._sign_rendering=!1,this._sign_nomore=!1,this._initList()},_initList:function(){function t(){var e=i._listContainer.height()+i._listContainer.offset().top;i._threshold>e-window.scrollY-window.innerHeight&&!i._sign_rendering&&!i._sign_nomore&&i._loadPage(),i._updatePage(function(){i._pageCache&&i._cacheData()})}var i=this;i._listContainer=e("<div/>",{"class":"infinitelist-container"}),i._listWrap.append(i._listContainer).append(i._listLoading),i._pageCache?i._resumeData():i._loadPage(),e(window).on("scroll",function(e){var i=this;setTimeout(function(){t.call(i,e)})})},_resumeData:function(){function t(t,n,a){var s=e("<div/>",{"class":"infinitelist-page infinitelist-pageindex"+t+" clearfix","data-page":t});n.cycled?a(s.addClass("recycled").css("height",n.data)):(i._pageListData[t]=n.data,n.data.length<i._pageSize&&i.noMore(),i._getPageDom(t,function(e){a(s.html(e))}))}var i=this;if(sessionStorage){var n=sessionStorage.getItem(this._cacheKey);if(n){var a,s=JSON.parse(n);for(a in s)if(s.hasOwnProperty(a)){var o=s[a],r=parseInt(a);t(r,o,function(e){i._listContainer.append(e)}),i._pageIndex=r+1}return sessionStorage.removeItem(i._cacheKey),void i._loadDone()}}this._loadPage()},_cacheData:function(){if(sessionStorage){var t={},i=this;e(".infinitelist-page").each(function(){var n=e(this).data("page"),a=e(this).hasClass("recycled");t[n]={cycled:a,data:a?e(this).css("height"):i._pageListData[n]}}),sessionStorage.setItem(i._cacheKey,JSON.stringify(t))}},_loadPage:function(){var t=this,i=t._pageIndex++;t._sign_rendering=!0,t._getPageDom(i,function(n){n&&(t._listContainer.append(e("<div/>",{"class":"infinitelist-page infinitelist-pageindex"+i+" clearfix","data-page":i}).html(n)),t._sign_rendering=!1),t._loadDone()})},_getPageItemOffset:function(e){var t=(window.scrollY+window.innerHeight/2-this._listContainer.offset().top)/e;return{min:Math.floor(t),max:Math.ceil(t)}},_updatePage:function(e){var t=this._listContainer.find(".infinitelist-page"),i=this._getPageItemOffset(t.first().height()).max,n=Math.ceil(this._pageKeepSize/2);t.length>this._pageKeepSize?(this._recyclePage(t.slice(0,i-n),t.slice(i+n,t.length)),this._resumePage(t.slice(i>n?i-n:0,i+n))):this._resumePage(t),e()},_resumePage:function(t){var i=this;t.each(function(){var t=e(this);t.hasClass("recycled")&&i._getPageDom(t.data("page"),function(e){t.html(e),t.css("height","auto"),t.removeClass("recycled")})})},_recyclePage:function(t,i){var n=this,a=[];t.each(function(){var t=e(this);t.hasClass("recycled")||(t.addClass("recycled"),t.css("height",t.height()),t.html(""))}),i.each(function(){var t=e(this),i=t.data("page");a.push(i),n._recycle&&delete n._pageListData[i]}),a.length>0&&(n._pageIndex=a.reduce(function(e,t){return e>t?t:e})),i.remove()},_getPageDom:function(e,t){var i=this;i._getData(e,function(e){t(i._htmlRender(e))})},_getData:function(t,n){var a=this;a._pageListData[t]?n(a._pageListData[t]):a._dataLoader(t,a._pageSize,function(s){1!==t||s&&s.length||a._listContainer.append(e(a._listNomore())),(i(s)&&s.length<a._pageSize||!s)&&a.noMore(),(i(s)&&0!=s.length||!i(s)&&!s)&&(a._pageListData[t]=s),n(s)},function(){1===t&&a._listContainer.append(e(a._listNomore())),a.noMore(),n([])})},reloadData:function(){var t=this,i=t._getPageItemOffset(e(".infinitelist-page").first().height());console.log(i),i.min>=0&&i.max>0&&(delete t._pageListData[i.min],delete t._pageListData[i.max],i.max===i.min?(t._sign_rendering=!0,t._getPageDom(i.min,function(n){e(".infinitelist-pageindex"+i.min).html(n),t._sign_rendering=!1,t._loadDone()})):(t._sign_rendering=!0,t._getPageDom(i.min,function(n){e(".infinitelist-pageindex"+i.min).html(n),t._sign_rendering=!1,t._loadDone()}),t._getPageDom(i.max,function(n){e(".infinitelist-pageindex"+i.max).html(n),t._sign_rendering=!1,t._loadDone()})))},noMore:function(){this._sign_nomore=!0,this._listLoading.hide()},clear:function(){this._listContainer.empty(),this._listLoading.show(),this._pageIndex=1,this._pageListData={},this._sign_nomore=!1,this._sign_rendering=!1,this._loadPage()}},n});