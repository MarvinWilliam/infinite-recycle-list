!function(e){"function"==typeof define&&"object"==typeof define.amd&&define.amd?define(function(){return e}):"undefined"!=typeof module&&module.exports?module.exports=e:window.InfiniteList=e}(function(){function e(){}function t(){return'<div style="text-align: center;padding: 10px 0;">No more</div>'}function i(e){return e?void this._setOptions(e):void console.warn("Infinitelist init options can not be null!")}return i.prototype={_setOptions:function(i){return i.listId?i.dataLoader?i.htmlRender?(this._listWrap=$("#"+i.listId),this._dataLoader=i.dataLoader,this._htmlRender=i.htmlRender,this._pageSize=i.pageSize||10,this._threshold=i.threshold||300,this._pageKeepSize=i.pageKeepSize||6,this._recycle=!!i.recycle,this._pageCache=!!i.pageCache,this._listNomore=i.listNomore||t,this._listLoading=$(i.listLoading||'<div style="text-align: center;padding: 10px 0;">Loading...</div>'),this._loadDone=i.loadDone||e,this._cacheKey=i.storageName||"INFINITELISTCACHE",this._pageIndex=1,this._pageListData={},this._sign_rendering=!1,this._sign_nomore=!1,void this._initList()):void console.warn("Options-htmlRender can not be null!"):void console.warn("Options-dataLoader can not be null!"):void console.warn("Options-listId can not be null!")},_initList:function(){function e(){var e=t._listContainer.height()+t._listContainer.offset().top;t._threshold>e-window.scrollY-window.innerHeight&&!t._sign_rendering&&!t._sign_nomore&&t._loadPage(),t._updatePage(function(){t._pageCache&&t._cacheData()})}var t=this;t._listContainer=$("<div/>",{"class":"infinitelist-container"}),t._listWrap.append(t._listContainer).append(t._listLoading),$(window).on("scroll",e),t._pageCache?t._resumeData():t._loadPage()},_resumeData:function(){function e(e,i,n){var a=$("<div/>",{"class":"infinitelist-page infinitelist-pageindex"+e+" recycled","data-page":e});i.cycled?n(a.css("height",i.data)):(t._pageListData[e]=i.data,t._getPageDom(e,function(e){n(a.html(e))}))}var t=this;if(sessionStorage&&sessionStorage.getItem(this._cacheKey)){var i=JSON.parse(sessionStorage.getItem(this._cacheKey)),n="";for(n in i){var a=i[n];e(~~n,a,function(e){t._listContainer.append(e)}),t._pageIndex=~~n+1}sessionStorage.removeItem(t._cacheKey)}else this._loadPage()},_cacheData:function(){if(sessionStorage){var e={},t=this;$(".infinitelist-page").each(function(){var i=$(this).data("page"),n=$(this).hasClass("recycled");e[i]={cycled:n,data:n?$(this).css("height"):t._pageListData[i]}}),sessionStorage.setItem(t._cacheKey,JSON.stringify(e))}},_loadPage:function(){var e=this,t=e._pageIndex++;e._sign_rendering=!0,e._getPageDom(t,function(i){e._listContainer.append($("<div/>",{"class":"infinitelist-page infinitelist-pageindex"+t,"data-page":t}).html(i)),e._sign_rendering=!1,e._loadDone()})},_getPageItemOffset:function(e){var t=(window.scrollY+window.innerHeight/2-this._listContainer.offset().top)/e;if(e>window.innerHeight){var i=1-window.innerHeight/e,n=Math.floor(t);n+.5+i>t&&n+.5-i<t&&(t=n)}return{min:Math.floor(t),max:Math.ceil(t)}},_updatePage:function(e){var t=this._listContainer.find(".infinitelist-page"),i=this._getPageItemOffset(t.first().height()).max,n=Math.ceil(this._pageKeepSize/2);t.length>this._pageKeepSize?(this._recyclePage(t.slice(0,i-n),t.slice(i+n,t.length)),this._resumePage(t.slice(i-n,i+n))):this._resumePage(t),e()},_resumePage:function(e){var t=this;e.each(function(){var e=$(this);e.hasClass("recycled")&&t._getPageDom(e.data("page"),function(t){e.html(t),e.css("height","auto"),e.removeClass("recycled")})})},_recyclePage:function(e,t){var i=this,n=[];e.each(function(){var e=$(this);e.hasClass("recycled")||(e.addClass("recycled"),e.css("height",e.height()),e.html(""))}),t.each(function(){var e=$(this),t=e.data("page");n.push(t),i._recycle&&delete i._pageListData[t]}),n.length>0&&(i._pageIndex=n.reduce(function(e,t){return e>t?t:e})),t.remove()},_getPageDom:function(e,t){var i=this;i._getData(e,function(e){t(i._htmlRender(e))})},_getData:function(e,t){var i=this;i._pageListData[e]?t(i._pageListData[e]):i._dataLoader(e,i._pageSize,function(n){1===e&&0===n.length&&i._listContainer.append($(i._listNomore())),n.length<i._pageSize&&(i._listLoading.hide(),i._nomoretag=!0),0!=n.length&&(i._pageListData[e]=n),t(n)},function(){t([])})},reloadData:function(){var e=this,t=e._getPageItemOffset($(".infinitelist-page").first().height());console.log(t),t.min>0&&t.max>0&&(delete e._pageListData[t.min],delete e._pageListData[t.max],t.max===t.min?e._getPageDom(t.min,function(e){$(".infinitelist-pageindex"+t.min).html(e)}):(e._getPageDom(t.min,function(e){$(".infinitelist-pageindex"+t.min).html(e)}),e._getPageDom(t.max,function(e){$(".infinitelist-pageindex"+t.max).html(e)})))},clear:function(){this._listContainer.empty(),this._listLoading.show(),this._pageIndex=1,this._pageListData={},this._sign_nomore=!1,this._sign_rendering=!1,this._loadPage()}},i}());